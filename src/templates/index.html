<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>C Compiler Insights</title>
    <link rel="stylesheet" href="/static/styles.css">

    <!-- CodeMirror Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/eclipse.min.css">

</head>
<body>
    <h1>ðŸ’» C Compiler Insights</h1>

    <div class="section">
        <label for="code"><strong>Enter your C code below:</strong></label>
        <textarea id="code">// Write your C code here...</textarea>
    </div>

    <div class="section">
        <button onclick="runLexical()">Lexical Analysis</button>
        <button onclick="runSyntax()">Syntax Analysis</button>
        <button onclick="runParseTree()">Show Parse Tree</button>
        <button onclick="runSemantic()">Semantic Analysis</button>
    </div>

    <div class="section">
        <h2>Lexical Analysis Output</h2>
        <h3>Tokens</h3>
        <pre id="tokens"></pre>
    </div>
    
    <div class="section">
        <h2>Symbol Table</h2>
        <table id="symbolTable">
            <thead>
            <tr>
                <th>SNo</th>
                <th>Token</th>
                <th>Attribute</th>
                <th>Attribute Number</th>
                <th>Memory Location</th>
            </tr>
            </thead>
            <tbody>
            
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>Syntax Analysis Output</h2>
        <pre id="syntaxOutput"></pre>
    </div>

    <div class="section">
        <h2>Parse Tree</h2>
        <img id="parseTreeImg" src="" alt="Parse Tree will appear here" style="max-width:100%; border:1px solid #ccc; padding:8px;">
    </div>

     <div class="section">
        <h2>Semantic Analysis Output</h2>
        <pre id="semanticOutput"></pre>
    </div>


    <!-- CodeMirror Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>

    <script>
        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode: "text/x-csrc",
            theme: "eclipse",
            lineNumbers: true,
            indentUnit: 4,
            smartIndent: true,
            tabSize: 4,
            matchBrackets: true,
            autoCloseBrackets: true
        });
        editor.setSize("100%", "400px");
        async function runLexical() {
            const code = editor.getValue();
            if (!code.trim()) {
                alert('Please enter some C code first.');
                return;
            }

            const formData = new FormData();
            formData.append('code', code);

            const res = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (res.ok) {
                document.getElementById('tokens').textContent = data.tokens.join('\n');
                const symbolTableData = data.symbol_table;
                const tbody = document.querySelector("#symbolTable tbody");
                symbolTableData.forEach(entry => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${entry.SNo}</td>
                    <td>${entry.Token}</td>
                    <td>${entry.Attribute}</td>
                    <td>${entry.AttributeNumber}</td>
                    <td>${entry.MemoryLocation}</td>
                `;
                tbody.appendChild(row);
                });
                document.getElementById('syntaxOutput').textContent = '';
            } else {
                alert('Lexical Analysis Error:\n' + (data.error || 'Unknown Error'));
            }
        }

        async function runSyntax() {
            const code = editor.getValue();
            if (!code.trim()) {
                alert('Please enter some C code first.');
                return;
            }

            const formData = new FormData();
            formData.append('code', code);

            const res = await fetch('/syntax', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (res.ok) {
                document.getElementById('syntaxOutput').textContent = data.syntax_output;
                document.getElementById('tokens').textContent = '';
                document.getElementById('symbolTable').textContent = '';
            } else {
                alert('Syntax Analysis Error:\n' + (data.error || 'Unknown Error') + '\n' + (data.details || ''));
            }
        }

        async function runSemantic() {
            const code = editor.getValue().trim();
            if (!code) { alert('Please enter some C code first.'); return; }

            const form = new FormData();
            form.append('code', code);

            const res = await fetch('/semantic', { method: 'POST', body: form });
            const data = await res.json();

            if (res.ok) {
                document.getElementById('semanticOutput').textContent = data.semantic_output;
            } else {
                alert('Semantic Analysis Error:\n' + (data.error || 'Unknown'));
            }
        }

        async function runParseTree() {
            const code = editor.getValue().trim();
            if (!code) { alert('Please enter some C code first.'); return; }

            const form = new FormData();
            form.append('code', code);

            const res = await fetch('/parse-tree', { method: 'POST', body: form });
            const data = await res.json();

            if (res.ok) {
                // set the <img> src to the returned URL,
                // and bust cache with a timestamp query
                const img = document.getElementById('parseTreeImg');
                img.src = data.parse_tree_url + '?t=' + new Date().getTime();
            } else {
                alert('Parse-Tree Error:\n' + (data.error || 'Unknown'));
            }
        }

    </script>
</body>
</html>
